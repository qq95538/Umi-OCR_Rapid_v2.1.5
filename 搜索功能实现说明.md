# Umi-OCR 记录页搜索功能实现说明

## 一、功能概述

为记录页（ResultsTableView）新增搜索功能，允许用户根据关键词快速筛选和查找OCR识别结果。

## 二、新增功能

### 2.1 搜索界面组件

在记录页的控制栏中新增以下UI元素：

1. **搜索词文本框** (`searchTextField`)
   - 位置：控制栏左侧
   - 功能：输入搜索关键词
   - 提示文本："输入搜索词，多个词用空格分隔"
   - 支持多个关键词，用空格分隔

2. **"仅显示搜索结果"按钮** (`searchButton`)
   - 位置：搜索文本框右侧
   - 功能：根据输入的关键词筛选记录
   - 点击后执行筛选逻辑

3. **"显示全部"按钮** (`showAllButton`)
   - 位置："仅显示搜索结果"按钮右侧
   - 功能：恢复显示所有记录
   - 仅在过滤状态时可用（isFiltering为true时启用）

4. **状态提示文本**
   - 位置：搜索栏第二行
   - 功能：显示当前记录状态
   - 过滤状态："当前显示过滤结果，共X条"（高亮颜色）
   - 全部状态："当前显示全部记录，共X条"

### 2.2 核心功能函数

#### `filterResults(searchText)`
**功能**：根据搜索关键词过滤显示结果

**参数**：
- `searchText`：用户输入的搜索文本

**逻辑**：
1. 如果搜索文本为空或只有空格，调用`showAllResults()`恢复全部显示
2. 使用正则表达式`/\s+/`按空格分割搜索词
3. 清空当前的`resultsModel`
4. 遍历`allResults`数组，检查每个记录是否包含所有关键词
5. 搜索范围包括：
   - `resText`：OCR识别的文本内容
   - `title`：记录标题（文件名-页码）
6. 匹配规则：必须包含所有输入的关键词（AND逻辑）
7. 搜索不区分大小写
8. 将匹配的记录添加到`resultsModel`
9. 设置`isFiltering = true`
10. 弹出提示："搜索完成，找到X条结果"

#### `showAllResults()`
**功能**：恢复显示所有记录

**逻辑**：
1. 检查当前是否处于过滤状态
2. 如果不是过滤状态，直接返回
3. 清空当前的`resultsModel`
4. 遍历`allResults`数组，将所有记录重新添加到`resultsModel`
5. 设置`isFiltering = false`
6. 弹出提示："已显示全部记录，共X条"

## 三、数据结构变更

### 3.1 新增属性

```javascript
property var allResults: []           // 存储所有结果的备份，用于搜索过滤
property bool isFiltering: false      // 是否处于过滤状态
```

### 3.2 修改的函数

#### `addOcrResult(res)`
**变更说明**：
- 新增：创建结果对象`resultObj`
- 新增：将结果同时添加到`resultsModel`和`allResults`
- 原有功能保持不变

#### `getResult(title, timestamp)`
**变更说明**：
- 搜索范围从`resultsModel`改为`allResults`
- 确保在过滤状态下也能正确查找

#### `selectDel()`
**变更说明**：
- 新增：从`allResults`中同步删除对应记录
- 使用`allResults.splice(li, l)`删除

#### `selectAllDel()`
**变更说明**：
- 新增：清空`allResults`数组
- 使用`allResults = []`

## 四、UI布局变更

### 4.1 控制栏高度调整
```javascript
height: size_.line * 3.5  // 从原来的1.5增加到3.5
```

### 4.2 控制栏布局结构
采用Column布局，分为两行：

**第一行**：
- "搜索词："标签
- 搜索文本框
- "仅显示搜索结果"按钮
- "显示全部"按钮

**第二行**：
- 状态提示文本

**右侧**（保持原有功能）：
- 自动滚动按钮
- 菜单按钮

## 五、使用方法

### 5.1 搜索记录
1. 在"搜索词"文本框中输入关键词
2. 支持多个关键词，用空格分隔（如："发票 2024"）
3. 点击"仅显示搜索结果"按钮
4. 系统将显示包含所有关键词的记录
5. 状态提示会显示找到的结果数量

### 5.2 恢复全部记录
1. 点击"显示全部"按钮
2. 系统恢复显示所有记录
3. 状态提示会显示总记录数量

### 5.3 清空搜索
- 如果搜索文本框为空，点击"仅显示搜索结果"会自动显示全部记录

## 六、技术实现细节

### 6.1 搜索算法
- 使用JavaScript的`String.includes()`方法进行子串匹配
- 统一转换为小写进行不区分大小写的搜索
- 多关键词使用AND逻辑，必须全部匹配

### 6.2 数据同步
- `allResults`作为主数据源，存储所有记录
- `resultsModel`作为显示模型，根据过滤状态动态更新
- 删除操作同时更新两个数据源

### 6.3 性能考虑
- 搜索时直接操作`allResults`数组，性能较好
- 过滤后只显示匹配的记录，减少UI渲染负担
- 支持大量记录的快速筛选

### 6.4 用户体验
- 实时显示当前记录数量
- 过滤状态用高亮颜色区分
- 按钮状态根据`isFiltering`自动启用/禁用
- 弹出提示确认操作结果

## 七、兼容性

### 7.1 向后兼容
- 保留所有原有功能
- 原有的复制、删除、选择等操作不受影响
- 自动滚动功能正常工作

### 7.2 集成说明
- 无需修改其他文件
- 仅修改`ResultsTableView.qml`一个文件
- 与现有的BatchDOC.qml、mission_doc.py等完全兼容

## 八、测试建议

### 8.1 功能测试
1. 测试单个关键词搜索
2. 测试多个关键词搜索（AND逻辑）
3. 测试不区分大小写搜索
4. 测试搜索结果为空的情况
5. 测试"显示全部"功能
6. 测试删除操作在过滤状态下的表现

### 8.2 边界测试
1. 搜索空字符串
2. 搜索只有空格的字符串
3. 搜索不存在的关键词
4. 大量记录（100+条）的搜索性能
5. 特殊字符搜索

### 8.3 UI测试
1. 控制栏高度适配
2. 按钮状态启用/禁用
3. 文本框输入体验
4. 提示信息显示
5. 主题颜色适配

## 九、文件清单

### 修改的文件
- `UmiOCR-data/qt_res/qml/Widgets/ResultLayout/ResultsTableView.qml`

### 新增的文档
- `搜索功能实现说明.md`（本文档）

## 十、总结

本次实现为Umi-OCR记录页添加了完整的搜索功能，包括：
- 搜索文本框
- "仅显示搜索结果"按钮
- "显示全部"按钮
- 状态提示
- 完整的搜索逻辑
- 数据同步机制

功能实现简洁高效，与现有系统完美集成，用户体验良好。支持多关键词搜索、不区分大小写、实时反馈等特性，大大提升了记录页的可用性。